version: '3.8'

services:
  backstage:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
      - "7007:7007"
    environment:
      # GitHub integration
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}

      # Kubernetes integration
      K8S_CLUSTER_URL: ${K8S_CLUSTER_URL:-}
      K8S_SERVICE_ACCOUNT_TOKEN: ${K8S_SERVICE_ACCOUNT_TOKEN:-}
      K8S_DASHBOARD_URL: ${K8S_DASHBOARD_URL:-}
      K8S_CA_DATA: ${K8S_CA_DATA:-}

      # ArgoCD integration
      ARGOCD_SERVER_URL: ${ARGOCD_SERVER_URL:-}
      ARGOCD_USERNAME: ${ARGOCD_USERNAME:-admin}
      ARGOCD_PASSWORD: ${ARGOCD_PASSWORD:-}

      # Prometheus integration
      PROMETHEUS_URL: ${PROMETHEUS_URL:-}

      # PostgreSQL (production only)
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-backstage}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-backstage}

      NODE_ENV: development
    volumes:
      - ./app-config.yaml:/app/app-config.yaml:ro
      - ./catalog-info.yaml:/app/catalog-info.yaml:ro
      - ../apps/frontend/catalog-info.yaml:/app/apps/frontend/catalog-info.yaml:ro
      - ../apps/backend/catalog-info.yaml:/app/apps/backend/catalog-info.yaml:ro
    depends_on:
      - postgres
    networks:
      - backstage

  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: backstage
      POSTGRES_PASSWORD: backstage
      POSTGRES_DB: backstage
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - backstage

volumes:
  postgres-data:

networks:
  backstage:
    driver: bridge
