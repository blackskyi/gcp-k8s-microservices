name: 3ï¸âƒ£ Build and Deploy Application

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'apps/**'
      - 'k8s-manifests/microservices/**'
      - '.github/workflows/3-build-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production

env:
  GCP_REGION: us-central1
  REGISTRY_LOCATION: us-central1-docker.pkg.dev

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    outputs:
      frontend_image: ${{ steps.meta-frontend.outputs.tags }}
      backend_image: ${{ steps.meta-backend.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY_LOCATION }}

      - name: Set image tags
        id: tags
        run: |
          FRONTEND_TAG="${{ env.REGISTRY_LOCATION }}/${{ secrets.GCP_PROJECT_ID }}/microservices-cluster-${{ github.event.inputs.environment || 'dev' }}-docker/frontend:${{ github.sha }}"
          BACKEND_TAG="${{ env.REGISTRY_LOCATION }}/${{ secrets.GCP_PROJECT_ID }}/microservices-cluster-${{ github.event.inputs.environment || 'dev' }}-docker/backend:${{ github.sha }}"

          echo "frontend_tag=$FRONTEND_TAG" >> $GITHUB_OUTPUT
          echo "backend_tag=$BACKEND_TAG" >> $GITHUB_OUTPUT

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/frontend
          push: true
          tags: |
            ${{ steps.tags.outputs.frontend_tag }}
            ${{ env.REGISTRY_LOCATION }}/${{ secrets.GCP_PROJECT_ID }}/microservices-cluster-${{ github.event.inputs.environment || 'dev' }}-docker/frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend
          push: true
          tags: |
            ${{ steps.tags.outputs.backend_tag }}
            ${{ env.REGISTRY_LOCATION }}/${{ secrets.GCP_PROJECT_ID }}/microservices-cluster-${{ github.event.inputs.environment || 'dev' }}-docker/backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update Kubernetes manifests
        run: |
          sed -i "s|FRONTEND_IMAGE_PLACEHOLDER|${{ steps.tags.outputs.frontend_tag }}|g" k8s-manifests/microservices/frontend/frontend-deployment.yaml
          sed -i "s|BACKEND_IMAGE_PLACEHOLDER|${{ steps.tags.outputs.backend_tag }}|g" k8s-manifests/microservices/backend/backend-deployment.yaml

      - name: Commit and push manifest changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add k8s-manifests/microservices/frontend/frontend-deployment.yaml
          git add k8s-manifests/microservices/backend/backend-deployment.yaml

          git diff --staged --quiet || git commit -m "Update image tags to ${{ github.sha }}"
          git push

      - name: Display build summary
        run: |
          echo "### Application Built and Pushed Successfully! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend Image:** ${{ steps.tags.outputs.frontend_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Backend Image:** ${{ steps.tags.outputs.backend_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will automatically deploy the updated manifests" >> $GITHUB_STEP_SUMMARY

  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Get cluster credentials
        run: |
          gcloud container clusters get-credentials microservices-cluster-${{ github.event.inputs.environment || 'dev' }} \
            --zone us-central1-a \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Force ArgoCD sync
        run: |
          echo "Checking ArgoCD application status..."
          kubectl get application microservices-app -n argocd

          echo "Forcing ArgoCD to hard refresh and sync..."
          kubectl patch application microservices-app -n argocd --type=json \
            -p='[{"op": "replace", "path": "/operation", "value": null}]' || true

          kubectl patch application microservices-app -n argocd --type=json \
            -p='[{"op": "add", "path": "/metadata/annotations/argocd.argoproj.io~1refresh", "value": "hard"}]'

          sleep 10

          echo "Triggering manual sync..."
          kubectl patch application microservices-app -n argocd --type=json \
            -p='[{"op": "replace", "path": "/spec/syncPolicy/automated", "value": {"prune": true, "selfHeal": true, "allowEmpty": false}}]'

      - name: Wait for ArgoCD sync
        run: |
          echo "Waiting for ArgoCD to sync and create resources..."

          # Wait for namespace to be created
          echo "Waiting for microservices namespace..."
          timeout=300
          elapsed=0
          while ! kubectl get namespace microservices &>/dev/null; do
            echo "Namespace not found yet, waiting... ($elapsed seconds elapsed)"
            sleep 10
            elapsed=$((elapsed + 10))
            if [ $elapsed -ge $timeout ]; then
              echo "ERROR: Timeout waiting for namespace. Checking ArgoCD status:"
              kubectl get applications -n argocd
              kubectl describe application microservices-app -n argocd || true
              exit 1
            fi
          done
          echo "âœ“ Namespace 'microservices' created"

          # Wait for deployments to be created
          echo "Waiting for frontend deployment..."
          timeout=300
          elapsed=0
          while ! kubectl get deployment frontend -n microservices &>/dev/null; do
            echo "Frontend deployment not found yet, waiting... ($elapsed seconds elapsed)"
            sleep 10
            elapsed=$((elapsed + 10))
            if [ $elapsed -ge $timeout ]; then
              echo "ERROR: Timeout waiting for deployments. Checking ArgoCD sync status:"
              kubectl get application microservices-app -n argocd -o yaml
              kubectl get all -n microservices
              exit 1
            fi
          done
          echo "âœ“ Frontend deployment created"

          echo "Waiting for backend deployment..."
          timeout=300
          elapsed=0
          while ! kubectl get deployment backend -n microservices &>/dev/null; do
            echo "Backend deployment not found yet, waiting... ($elapsed seconds elapsed)"
            sleep 10
            elapsed=$((elapsed + 10))
            if [ $elapsed -ge $timeout ]; then
              echo "ERROR: Timeout waiting for backend deployment"
              kubectl get all -n microservices
              exit 1
            fi
          done
          echo "âœ“ Backend deployment created"

          echo "All ArgoCD resources have been created successfully!"

      - name: Check deployment status
        run: |
          kubectl rollout status deployment/frontend -n microservices --timeout=5m
          kubectl rollout status deployment/backend -n microservices --timeout=5m

      - name: Get application URL
        id: app_url
        run: |
          FRONTEND_IP=$(kubectl get svc frontend -n microservices -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "frontend_url=http://$FRONTEND_IP" >> $GITHUB_OUTPUT

      - name: Health check
        run: |
          echo "Testing application health..."
          curl -f ${{ steps.app_url.outputs.frontend_url }}/health || echo "Health check pending..."

      - name: Display deployment summary
        run: |
          echo "### Deployment Verified Successfully! âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URL:** ${{ steps.app_url.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pod Status:**" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n microservices >> $GITHUB_STEP_SUMMARY
