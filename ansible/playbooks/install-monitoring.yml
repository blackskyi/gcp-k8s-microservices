---
# Install Prometheus and Grafana monitoring stack on GKE
# Run with: ansible-playbook -i ../inventory/localhost install-monitoring.yml

- name: Install Prometheus and Grafana Monitoring Stack
  hosts: local
  gather_facts: yes

  vars:
    monitoring_namespace: "monitoring"
    cluster_name: "{{ lookup('env', 'CLUSTER_NAME') | default('microservices-cluster', true) }}"
    gcp_project: "{{ lookup('env', 'GCP_PROJECT') }}"
    gcp_zone: "{{ lookup('env', 'GCP_ZONE') | default('us-central1-a', true) }}"

  tasks:
    - name: Verify kubectl is installed
      command: kubectl version --client
      register: kubectl_version
      changed_when: false

    - name: Verify helm is installed
      command: helm version --short
      register: helm_version
      changed_when: false

    - name: Display tool versions
      debug:
        msg:
          - "kubectl: {{ kubectl_version.stdout_lines[0] }}"
          - "helm: {{ helm_version.stdout }}"

    - name: Configure kubectl to use GKE cluster
      shell: |
        gcloud container clusters get-credentials {{ cluster_name }} \
          --zone {{ gcp_zone }} \
          --project {{ gcp_project }}
      environment:
        USE_GKE_GCLOUD_AUTH_PLUGIN: "True"
      when: gcp_project != ""

    - name: Create monitoring namespace
      kubernetes.core.k8s:
        name: "{{ monitoring_namespace }}"
        api_version: v1
        kind: Namespace
        state: present

    - name: Add Prometheus Helm repository
      kubernetes.core.helm_repository:
        name: prometheus-community
        repo_url: https://prometheus-community.github.io/helm-charts

    - name: Add Grafana Helm repository
      kubernetes.core.helm_repository:
        name: grafana
        repo_url: https://grafana.github.io/helm-charts

    - name: Update Helm repositories
      command: helm repo update
      changed_when: false

    - name: Install kube-prometheus-stack (Prometheus + Grafana)
      kubernetes.core.helm:
        name: kube-prometheus-stack
        chart_ref: prometheus-community/kube-prometheus-stack
        release_namespace: "{{ monitoring_namespace }}"
        create_namespace: yes
        values:
          prometheus:
            prometheusSpec:
              retention: 7d
              resources:
                requests:
                  cpu: 200m
                  memory: 512Mi
                limits:
                  cpu: 500m
                  memory: 2Gi
              storageSpec:
                volumeClaimTemplate:
                  spec:
                    accessModes: ["ReadWriteOnce"]
                    resources:
                      requests:
                        storage: 10Gi

          grafana:
            enabled: true
            adminPassword: "admin123"  # Change this!
            service:
              type: LoadBalancer
            persistence:
              enabled: true
              size: 5Gi
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 200m
                memory: 256Mi

            # Default dashboards
            dashboardProviders:
              dashboardproviders.yaml:
                apiVersion: 1
                providers:
                  - name: 'default'
                    orgId: 1
                    folder: ''
                    type: file
                    disableDeletion: false
                    editable: true
                    options:
                      path: /var/lib/grafana/dashboards/default

            # Pre-configured dashboards
            dashboards:
              default:
                kubernetes-cluster:
                  gnetId: 7249
                  revision: 1
                  datasource: Prometheus
                kubernetes-pods:
                  gnetId: 6417
                  revision: 1
                  datasource: Prometheus
                node-exporter:
                  gnetId: 1860
                  revision: 31
                  datasource: Prometheus

          alertmanager:
            enabled: true
            alertmanagerSpec:
              storage:
                volumeClaimTemplate:
                  spec:
                    accessModes: ["ReadWriteOnce"]
                    resources:
                      requests:
                        storage: 5Gi

          nodeExporter:
            enabled: true

          kubeStateMetrics:
            enabled: true

    - name: Wait for Prometheus to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: StatefulSet
        name: prometheus-kube-prometheus-stack-prometheus
        namespace: "{{ monitoring_namespace }}"
      register: prometheus_sts
      until: prometheus_sts.resources[0].status.readyReplicas is defined and prometheus_sts.resources[0].status.readyReplicas > 0
      retries: 30
      delay: 10

    - name: Wait for Grafana to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: kube-prometheus-stack-grafana
        namespace: "{{ monitoring_namespace }}"
      register: grafana_deployment
      until: grafana_deployment.resources[0].status.readyReplicas is defined and grafana_deployment.resources[0].status.readyReplicas > 0
      retries: 30
      delay: 10

    - name: Get Grafana service details
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: kube-prometheus-stack-grafana
        namespace: "{{ monitoring_namespace }}"
      register: grafana_service

    - name: Wait for Grafana LoadBalancer IP
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: kube-prometheus-stack-grafana
        namespace: "{{ monitoring_namespace }}"
      register: grafana_lb
      until: grafana_lb.resources[0].status.loadBalancer.ingress is defined
      retries: 20
      delay: 10

    - name: Get Grafana external IP
      set_fact:
        grafana_external_ip: "{{ grafana_lb.resources[0].status.loadBalancer.ingress[0].ip }}"

    - name: Get Prometheus service details
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: kube-prometheus-stack-prometheus
        namespace: "{{ monitoring_namespace }}"
      register: prometheus_service

    - name: Display monitoring access information
      debug:
        msg:
          - "=========================================="
          - "Monitoring Stack installed successfully!"
          - "=========================================="
          - "Grafana URL: http://{{ grafana_external_ip }}"
          - "Grafana Username: admin"
          - "Grafana Password: admin123"
          - ""
          - "Prometheus: kube-prometheus-stack-prometheus.{{ monitoring_namespace }}.svc:9090"
          - "Alertmanager: kube-prometheus-stack-alertmanager.{{ monitoring_namespace }}.svc:9093"
          - "=========================================="
          - ""
          - "Pre-configured Dashboards:"
          - "  - Kubernetes Cluster Monitoring"
          - "  - Kubernetes Pods"
          - "  - Node Exporter"
          - "=========================================="

    - name: Save monitoring credentials to file
      copy:
        content: |
          Monitoring Stack Access Information
          ====================================

          Grafana
          -------
          URL: http://{{ grafana_external_ip }}
          Username: admin
          Password: admin123

          Prometheus (Internal)
          ---------------------
          URL: http://kube-prometheus-stack-prometheus.{{ monitoring_namespace }}.svc:9090

          Alertmanager (Internal)
          -----------------------
          URL: http://kube-prometheus-stack-alertmanager.{{ monitoring_namespace }}.svc:9093

          Pre-configured Dashboards:
          - Kubernetes Cluster Monitoring (ID: 7249)
          - Kubernetes Pods (ID: 6417)
          - Node Exporter (ID: 1860)

          WARNING: Change the default Grafana password!
        dest: "{{ playbook_dir }}/../../monitoring-credentials.txt"
        mode: '0600'

    - name: Create port-forward script for Prometheus (optional)
      copy:
        content: |
          #!/bin/bash
          # Port-forward Prometheus to localhost:9090
          kubectl port-forward -n {{ monitoring_namespace }} svc/kube-prometheus-stack-prometheus 9090:9090
        dest: "{{ playbook_dir }}/../../port-forward-prometheus.sh"
        mode: '0755'

    - name: Create port-forward script for Alertmanager (optional)
      copy:
        content: |
          #!/bin/bash
          # Port-forward Alertmanager to localhost:9093
          kubectl port-forward -n {{ monitoring_namespace }} svc/kube-prometheus-stack-alertmanager 9093:9093
        dest: "{{ playbook_dir }}/../../port-forward-alertmanager.sh"
        mode: '0755'
